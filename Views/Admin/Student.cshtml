<!DOCTYPE html>
<html>

<head>
    <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/pako/dist/pako_deflate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>


</head>

<body>
    @* <h2 class="text-danger">@TempData["Userid"]</h2> *@
    <div class="mb-3">
        <h3>Student Details </h3>
    </div>
    <a href="/admin/TreeList" class="btn btn-primary mb-3">View Students in Treelist</a>
    <div class="d-flex mb-3 ">
        <button id="deleteSelected" onClick="multiDelete()" class=" btn btn-danger me-2">Delete Selected</button>
        <button onClick="exportPDF()" class=" btn btn-success me-2">Export to PDF</button>
        <input type="text" id="searchInput" placeholder="Search..." class="form-control w-25 mb-2" />
    </div>
    <div id="notification"></div>

    <div id="grid"></div>

    <div class="mt-2" id="select-button">
        <button id="pagination-prev" class="btn btn-secondary">Previous</button>
        <button id="pagination-next" class="btn btn-secondary">Next</button>
    </div>

    @section Scripts {
        <script id="insert-success-template" type="text/x-kendo-template">
                            <div class="notification-popup p-3">
                                <h5>#= title #</h5>
                                <p>#= message #</p>
                            </div>
                        </script>
        <script>
            var dataSource;
            var pageNumber = 1;
            var pageSize = 10;



            function multiDelete() {
                var selectedIds = [];
                var grid = $("#grid").data("kendoGrid");
                var selectedItems = grid.select();

                selectedItems.each(function (index, row) {
                    var dataItem = grid.dataItem(row);
                    selectedIds.push(dataItem.c_id);
                });
                console.log(selectedIds);

                if (selectedIds.length === 0) {
                    kendo.alert("Please select at least one record to delete.", "warning");
                    return;
                }

                kendo.confirm('Are you sure you want to delete this record?').then(function () {
                    console.log(selectedIds);
                    $.ajax({
                        url: "Multidelete",
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(selectedIds),
                        success: function (response) {
                            kendo.alert("Data Deleted successfully.", "success");
                            dataSource.read();
                        },
                        error: function (xhr, status, error) {
                            console.error(error);
                            kendo.alert("Error in Deleting Data", "error");
                        }
                    });
                }).catch(function () {
                    console.error("Delete operation cancelled.");
                });
            }

            function loadData(pageNumber, pageSize) {
                $.ajax({
                    url: "Pagination",
                    type: "GET",
                    data: { pageNumber: pageNumber, pageSize: pageSize },
                    success: function (response) {
                        dataSource.data(response);
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            }

            function exportPDF() {
                var jsPDF = window.jspdf.jsPDF;

                var grid = $("#grid").data("kendoGrid");
                var dataSource = grid.dataSource;

                dataSource.fetch(function () {
                    var data = dataSource.view();

                    console.log("Data extracted from the grid:", data);

                    var doc = new jsPDF();

                    var headers = Object.keys(data[0].toJSON());

                    var rows = [];
                    data.forEach(function (item) {
                        var row = [];
                        headers.forEach(function (header) {
                            row.push(item.get(header));
                        });
                        rows.push(row);
                    });

                    doc.autoTable({
                        head: [headers],
                        body: rows
                    });

                    doc.save("grid_data.pdf");
                });
            }





            $(document).ready(function () {

                $("#select-button").kendoButtonGroup({
                    index: 0
                });

                var searchInput = $("#searchInput");
                searchInput.on("keypress", function (e) {
                    if (e.which === 13) {
                        var query = searchInput.val();
                        $.ajax({
                            url: "ViewDatasearch",
                            type: "GET",
                            data: { query: query },
                            success: function (response) {
                                dataSource.data(response);
                            },
                            error: function (xhr, status, error) {
                                console.error(error);
                            }
                        });
                    }
                });


                var notification = $("#notification").kendoNotification({
                    position: {
                        pinned: true,
                        top: 30,
                        right: 30
                    },
                    autoHideAfter: 3000,
                    stacking: "down",
                    templates: [{
                        type: "insert-success",
                        template: $("#insert-success-template").html()
                    }]
                }).data("kendoNotification");

                loadData(pageNumber, pageSize);

                $("#pagination-prev").click(function () {
                    pageNumber--;
                    loadData(pageNumber, pageSize);
                });

                $("#pagination-next").click(function () {
                    pageNumber++;
                    loadData(pageNumber, pageSize);
                });

                var userId = parseInt('@TempData["Userid"]');
                dataSource = new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: "ViewData",
                            dataType: "json"
                        },
                        create: {
                            url: "Student",
                            type: "POST",
                            dataType: "json",
                            complete: function () {
                                notification.show({ title: "Insert", message: "Data inserted successfully." }, "insert-success");

                                dataSource.read();
                            }

                        },
                        destroy: {
                            url: function (data) {
                                return "Delete/" + data.c_id;
                            },
                            type: "POST",
                            dataType: "json",
                            complete: function () {
                                notification.show({ title: "Delete", message: "Data Deleted successfully." }, "insert-success");

                                dataSource.read();
                            }
                        },
                        update: {
                            url: "update",
                            type: "POST",
                            dataType: "json",
                            complete: function () {
                                notification.show({ title: "Update", message: "Data Updated successfully." }, "insert-success");

                                dataSource.read();
                            }
                        }
                    },
                    pageSize: 10,
                    schema: {
                        model: {
                            id: "c_id",
                            fields: {
                                c_id: { type: "number", editable: false, nullable: false },
                                c_userid: { type: "number" },
                                c_first_name: {
                                    type: "string", validation: {
                                        required: true,
                                        firstnamevalidation: function (input) {
                                            if (input.is("[name='c_first_name']") && input.val() != "") {
                                                input.attr("data-productnamevalidation-msg", " Name should start with capital letter And also contains Alpha ");
                                                return /^[A-Z][A-Za-z]*$/.test(input.val());
                                            }

                                            return true;
                                        }
                                    }
                                },
                                c_last_name: {
                                    type: "string", validation: {
                                        required: true,
                                        lastnamevalidation: function (input) {
                                            if (input.is("[name='c_last_name']") && input.val() != "") {
                                                input.attr("data-productnamevalidation-msg", " Name should start with capital letter And also contains Alpha ");
                                                return /^[A-Z][A-Za-z]*$/.test(input.val());
                                            }

                                            return true;
                                        }
                                    }
                                },
                                c_dob: {
                                    type: "string",
                                    validation: {
                                        required: true,
                                        dateValidation: function (input) {
                                            if (input.is("[name='c_dob']") && input.val() != "") {
                                                var currentDate = new Date();
                                                var selectedDate = new Date(input.val());
                                                if (selectedDate > currentDate) {
                                                    input.attr("data-datevalidation-msg", "Date cannot be in the future");
                                                    return false;
                                                }
                                            }
                                            return true;
                                        }
                                    }
                                },
                                c_gender: { type: "string", validation: { required: true } },
                                c_age: { type: "string", validation: { required: true }, attributes: { disabled: true } },
                                c_address: { type: "string", validation: { required: true } },
                                c_contactno: {
                                    type: "string",
                                    validation: {
                                        required: true,
                                        contactNoValidation: function (input) {
                                            if (input.is("[name='c_contactno']") && input.val() != "") {
                                                input.attr("data-contactnovalidation-msg", "Contact No. must be 10 digits");
                                                return /^\d{10}$/.test(input.val());
                                            }
                                            return true;
                                        }
                                    }
                                },
                                c_profile: { type: "string" },
                            }
                        }
                    }
                });

                $("#grid").kendoGrid({
                    dataSource: dataSource,
                    columns: [
                        { selectable: true, width: "50px" },
                        { title: "SrNo", width: "50px" },
                        {
                            field: "c_userid",
                            title: "Teacher NAme",
                            editor: function (container, options) {
                                $('<input name="' + options.field + '" class="k-input k-textbox" required/>').appendTo(container).kendoDropDownList({
                                    dataSource: {
                                        transport: {
                                            read: {
                                                url: "ViewTeacherData",
                                                dataType: "json"
                                            }
                                        }
                                    },
                                    dataTextField: "c_first_name",
                                    dataValueField: "c_id",
                                    optionLabel: "--Select--",
                                    required: true
                                });
                            },
                            template: function (dataItem) {
                                return dataItem.c_user_first_name;
                            }
                        },
                        { field: "c_id", title: "Bookid", hidden: true },
                        { field: "c_first_name", title: "First Name" },
                        { field: "c_last_name", title: "Last Name" },
                        {
                            field: "c_dob",
                            title: "Date",
                            template: "#= kendo.toString(new Date(c_dob), 'yyyy-MM-dd') #",
                            editor: function (container, options) {
                                var initialDate = options.model.c_dob ? kendo.toString(new Date(options.model.c_dob), 'yyyy/MM/dd') : kendo.toString(new Date(), 'yyyy/MM/dd');

                                $('<input name="c_dob" required="required" />').appendTo(container).kendoDatePicker({
                                    format: "yyyy/MM/dd",
                                    value: initialDate,
                                    change: function (e) {
                                        var parsedDate = kendo.toString(new Date(this.value()), 'yyyy/MM/dd');
                                        var dateOnly = parsedDate.split("T")[0];
                                        options.model.set("c_dob", dateOnly);

                                        var selectedDate = this.value();
                                        var today = new Date();
                                        var birthDate = new Date(selectedDate);
                                        var age = today.getFullYear() - birthDate.getFullYear();
                                        var m = today.getMonth() - birthDate.getMonth();
                                        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                                            age--;
                                        }
                                        options.model.set("c_age", age);
                                    }
                                }).data("kendoDatePicker").trigger("change");
                            }
                        },
                        {
                            field: "c_gender",
                            title: "State Type",
                            editor: function (container, options) {
                                $('<input type="radio" name="' + options.field + '" value="Male" required /> Male<br>').appendTo(container);
                                $('<input type="radio" name="' + options.field + '" value="Female" required /> Female<br>').appendTo(container);
                            },
                            template: function (dataItem) {
                                return dataItem.c_gender;
                            }
                        },
                        {
                            field: "c_age",
                            title: "AGE",
                            template: function (dataItem) {
                                return dataItem.c_age + " years";
                            },

                        },
                        { field: "c_address", title: "Address", },
                        { field: "c_contactno", title: "Phone no" },
                        {
                            field: "c_profile",
                            title: "Photo",
                            template: function (dataItem) {
                                return "<img src='/photos/" + dataItem.c_profile + "' alt='Photo' style='max-width: 100px; max-height: 100px;'/>";
                            },
                            editor: function (container, options) {
                                var input = $('<input name="' + options.field + '" type="file"  />').appendTo(container);
                                if (options.model.c_profile) {
                                    var currentImage = $("<img src='/photos/" + options.model.c_profile + "' alt='Photo' style='max-width: 100px; max-height: 100px;'/>");
                                    container.append(currentImage);
                                }
                                input.change(function () {
                                    var formData = new FormData();
                                    formData.append("photo", input[0].files[0]);

                                    $.ajax({
                                        url: "UploadPhoto",
                                        type: "POST",
                                        data: formData,
                                        contentType: false,
                                        processData: false,
                                        success: function (response) {
                                            options.model.set("c_profile", response.filename);

                                            if (currentImage) {
                                                currentImage.attr('src', '/photos/' + response.filename);
                                            } else {
                                                currentImage = $("<img src='/photos/" + response.filename + "' alt='Photo' style='max-width: 100px; max-height: 100px;'/>");
                                                container.append(currentImage);
                                            }
                                        },
                                        error: function (xhr, status, error) {
                                            console.error("Error uploading photo:", error);
                                        }
                                    });
                                });
                            }
                        },


                        { command: ["edit", "destroy"], title: "&nbsp;", width: "200px" }
                    ],
                    dataBound: function (e) {
                        var grid = e.sender;
                        $(grid.tbody).find("tr").each(function (index) {
                            $(this).find("td:nth-child(2)").text(index + 1 + grid.dataSource.pageSize() * (grid.dataSource.page() - 1));
                        });
                    },
                    editable: {
                        mode: "popup",
                        window: {
                            title: "Add"
                        }
                    },
                    edit: function (e) {
                        var popupWindow = this.editable.element.data("kendoWindow");
                        if (e.model.isNew()) {
                            popupWindow.title("Add");
                            e.container.find(".k-grid-update").text("Create");
                        } else {
                            popupWindow.title("Update");
                        }
                        e.container.find(".k-edit-label:contains('SrNo')").css("display", "none");
                        e.container.find(".k-edit-label:contains('SrNo')").next(".k-edit-field").css("display", "none");
                        e.container.find(".k-edit-label:contains('Bookid')").css("display", "none");
                        e.container.find(".k-edit-label:contains('Bookid')").next(".k-edit-field").css("display", "none");


                    },
                    toolbar: [{ name: "create", text: "Add Data" }],
                    sortable: true,
                    filterable: true,
                });

                dataSource.bind("requestEnd", function (e) {
                    if (e.type === "create" || e.type === "update" || e.type === "destroy") {
                        dataSource.read();
                    }
                });
            });
        </script>
    }
</body>

</html>
